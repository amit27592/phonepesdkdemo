<!-- //Web::Jatin Remove the testing infra -->

<!doctype html>
<html>

<head>
  <h1 align="middle"> Automation App for Phonepe </h1>
</head>

<body>
  <style>
    button,
    td,
    input {
      font-size: 30px;
    }

    #log {
      background-color: #f6f8fa;
      border-radius: 3px;
      font-size: 85%;
      line-height: 1.45;
      overflow: auto;
      padding: 16px;
    }

    #main {
      display: flex;
      flex-direction: column;
    }

    .input {
      background-color: #f1f1f1;
      margin: 10px;
      padding: 10px;
      display: flex;
      justify-content: center;
    }
  </style>
  <script src="./bundle.js"></script>
  <div id="log"></div>
  <div id="main">

    <div class="input">
      <input type="button" value="clear" onclick="clearLog();" />
    </div>
    <table id="maintable" align="middle" cellspacing="10">
    </table>


  </div>
  <script>
    (function () {
      if (!console) {
        console = {};
      }
      var old = console.log;
      var logger = document.getElementById('log');
      console.log = function (message) {
        if (typeof message == 'object') {
          logger.innerHTML += (JSON && JSON.stringify ? JSON.stringify(message) : String(message)) + '<br />';
        } else {
          logger.innerHTML += message + '<br />';
        }
      }
    })();

    function clearLog() {
      document.getElementById('log').innerHTML = ""
    }

    let actionButtonProp = new PhonePe.PaymentModels.ActionButtonProp('Done')
    let confirmationState = { [PhonePe.PaymentModels.TransactionState.COMPLETED]: actionButtonProp }

    var exportedFuncs = {
      "initializeSdk": {
        "name": "initializeSdk",
        "idx": 0,
        "input": ["android"],
        "args": ["{android}"],
        "customImpl": (ev) => {
          var os = document.getElementById("input-0-android")
          PhonePe.PhonePe.build(PhonePe.Constants.Species.web, os.value).then((sdk) => {
            window.sdk = sdk
          })
        }
      },
      "clearLog": {
        "name": "clearLog",
        "idx": 1
      },
      "setItem": {
        "name": "setItem",
        "idx": 2,
        "success": "Success: ",
        "error": "Error: ",
        "args": ["test", "key", "value"]
      },
      "getData": {
        "name": "getData",
        "idx": 3,
        "args": ['test', 'key', null]
      },
      "removeData": {
        "name": "removeData",
        "idx": 4,
        "args": ['test', 'key']
      },
      "startUpdatingLocation": {
        "name": "startUpdatingLocation",
        "idx": 5
      },
      "stopUpdatingLocation": {
        "name": "stopUpdatingLocation",
        "idx": 6
      },
      "registerLocationUpdateSuccessCallback": {
        "name": "registerLocationUpdateSuccessCallback",
        "idx": 7,
        "args": ["callbackName", (resp) => {
          console.log('Location success response = ' + JSON.stringify(response))
        }]
      },
      "registerLocationUpdateFailureCallback": {
        "name": "registerLocationUpdateFailureCallback",
        "idx": 8,
        "args": ["callbackName", (resp) => {
          console.log('Location success response = ' + JSON.stringify(response))
        }]
      },
      "getCurrentLocation": {
        "name": "getCurrentLocation",
        "idx": 9,
        "success": "location received on js side = ",
        "error": "Error found when fetching location = "
      },
      "navigateToTransactionDetails": {
        "name": "openTransactionDetailsPage",
        "idx": 10,
        "args": ["{txnId}"],
        "input": ["txnId"]
      },
      "navigateToPayments": {
        "name": "openPaymentsPage",
        "idx": 11,
        "args": ['Ticket New', {
          "merchantId": "TICKETNEWTEST",
          "merchantTransactionId": "transactionId010",
          "reservationId": "W1803281253545745701305",
          "serviceCategory": "MOVIE",
          "validFor": 86400,
          "payableAmount": 5000,
          "quantity": 2
        },
          "", "",
          [{
            "Movie Name": "Avengers"
          }, { "Seats": "3A, 3B, 3C" }],
          confirmationState
        ]
      },
      "navigateToHelpPage": {
        "name": "navigateToPage",
        "idx": 12,
        // "args": [new PhonePe.HelpPageNavigationRequest("dshbcjd")]
      },
      "getUserDetails": {
        "name": "getUserDetails",
        "idx": 13,
        "args": [[PhonePe.Constants.UserDetail.email, PhonePe.Constants.UserDetail.phoneNumber,
        PhonePe.Constants.UserDetail.isEmailVerified, PhonePe.Constants.UserDetail.name]]
      },
      "seekPermission": {
        "name": "seekPermission",
        "idx": 14,
        "args": [[PhonePe.Constants.Permission.READ_SMS, PhonePe.Constants.Permission.LOCATION]]
      },
      "openSettingsPage": {
        "name": "openSettingsPageForPermission",
        "idx": 15,
        "success": "Successfully opened settings page",
        "error": "Failed to open settings page with error = "
      },
      "logMerchantEvent": {
        "name": "logMerchantEvent",
        "idx": 16,
        "args": ["Test", { 'key': 'value' }]
      },
      "replace": {
        "name": "replace",
        "idx": 17,
        "customImpl": (ev) => {
          console.log('Using Replace state');

          if (history.replaceState) {
            history.replaceState(null, "Page", "test.html");
            history.go(0);
          } else {
            location.replace(url);
          }
        }
      },
      "setCookie": {
        "name": "setCookie",
        "idx": 18,
        "customImpl": (ev) => {
          console.log('Setting test cookie')
          document.cookie = 'test1=test1'
        }
      },
      "getCookie": {
        "name": "getCookie",
        "idx": 19,
        "customImpl": (ev) => {
          console.log(document.cookie)
        }
      },
      "reserveOrder": {
        "name": "reserveOrder",
        "idx": 20,
        "args": [{
          reservationId: "WSR1812171834347378532294",
          merchantId: "ONNBIKESTEST",
          merchantOrderId: "5c0fba626a8e2e627f83af45"
        }, 'ONNBIKESTEST'],
        "success": "res2 = ",
        "error": "Failed to reserve order with error = "
      },
      "selectFile": {
        "name": "selectFile",
        "idx": 21,
        "type": "promise",
        "args": ["image", true]
      }
    }

    for (let key in exportedFuncs) {
      var exportedFunc = exportedFuncs[key]
      var tr = document.createElement('tr')
      var td = document.createElement('td')
      tr.appendChild(td)

      var ip = document.createElement('input')
      ip.id = "clickMe" + exportedFunc.idx
      ip.type = 'button'

      if (exportedFunc.input) {
        exportedFunc.input.forEach((input) => {
          var ip = document.createElement('input')
          ip.id = "input-" + exportedFunc.idx + '-' + input
          ip.type = 'input'
          ip.value = input
          tr.appendChild(ip)

        })
      }
      addEventListener(exportedFunc)
      ip.value = key
      tr.appendChild(ip)
      var main = document.getElementById('maintable')
      main.appendChild(tr)
    }

    function addEventListener(exportedFunc) {
      if (exportedFunc.customImpl) {
        ip.addEventListener('click', exportedFunc.customImpl)
        return
      } else {
        ip.addEventListener('click', () => {
          var fn = sdk[exportedFunc.name]
          var args = exportedFunc.args
          var newArgs = []
          if (exportedFunc.args) {
            exportedFunc.args.forEach((arg) => {
              if (typeof arg == "string" && arg.startsWith("{")) {
                var realArgName = arg.substr(1, arg.lastIndexOf("}") - 1)
                var id = "input-" + exportedFunc.idx + '-' + realArgName
                var ele = document.getElementById(id)
                var argValue = ele.value
                newArgs.push(argValue)
                return
              } else
                newArgs.push(arg)

            })
            var res = fn.apply(sdk, newArgs)
            if (res.constructor === Promise) {
              res.then((result) => {
                if (exportedFunc.success) {
                  if(typeof result == "object")
                    result = JSON.stringify(result)
                  console.log(exportedFunc.success + result)
                } else {
                  console.log(result)
                }
              }).catch((err) => {
                if (exportedFunc.error) {
                  if(typeof err == "object")
                    err = JSON.stringify(err)
                  console.log.apply(exportedFunc.error + err)
                } else {
                  console.log(err)
                }
              })
            }
          }
        })
      }


    }

    window.onerror = function myErrorHandler(errorMsg, url, lineNumber) {
      console.log("Error occured: " + errorMsg);
      return false;
    }



  </script>

</body>

</html>